generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  STAFF
  ADMIN
}

enum SaleStatus {
  COMPLETED
  REFUNDED
  VOID
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  passwordHash String     @map("password_hash")
  name         String
  role         UserRole   @default(OWNER)
  sales        Sale[]
  settings     Setting[]
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@map("users")
}

model Branch {
  id        String   @id @default(uuid())
  name      String
  address   String?
  timezone  String   @default("UTC")
  isActive  Boolean  @default(true) @map("is_active")
  items     Item[]
  sales     Sale[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("branches")
}

model Item {
  id           String   @id @default(uuid())
  branchId     String   @map("branch_id")
  branch       Branch   @relation(fields: [branchId], references: [id])
  name         String
  sku          String?
  defaultPrice Decimal  @db.Decimal(10, 2) @map("default_price")
  taxRate      Decimal  @db.Decimal(5, 2) @map("tax_rate")
  saleItems    SaleItem[]
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([branchId, sku])
  @@map("items")
}

model Sale {
  id             String     @id @default(uuid())
  branchId       String     @map("branch_id")
  userId         String     @map("user_id")
  branch         Branch     @relation(fields: [branchId], references: [id])
  user           User       @relation(fields: [userId], references: [id])
  totalBeforeTax Decimal    @db.Decimal(12, 2) @map("total_before_tax")
  taxAmount      Decimal    @db.Decimal(12, 2) @map("tax_amount")
  totalAmount    Decimal    @db.Decimal(12, 2) @map("total_amount")
  currency       String     @default("USD") @db.VarChar(3)
  saleTimestamp  DateTime   @default(now()) @map("sale_timestamp")
  customerName   String?    @map("customer_name")
  customerEmail  String?    @map("customer_email")
  receiptNumber  String     @unique @map("receipt_number")
  status         SaleStatus @default(COMPLETED)
  items          SaleItem[]
  receipt        Receipt?
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  @@index([branchId, saleTimestamp(sort: Desc)])
  @@index([status, saleTimestamp(sort: Desc)])
  @@index([saleTimestamp])
  @@index([branchId])
  @@index([customerEmail])
  @@map("sales")
}

model SaleItem {
  id                 String   @id @default(uuid())
  saleId             String   @map("sale_id")
  sale               Sale     @relation(fields: [saleId], references: [id])
  itemId             String?  @map("item_id")
  item               Item?    @relation(fields: [itemId], references: [id])
  description        String
  quantity           Int
  unitPrice          Decimal  @db.Decimal(12, 2) @map("unit_price")
  taxRate            Decimal  @db.Decimal(5, 2) @map("tax_rate")
  lineTotalBeforeTax Decimal  @db.Decimal(12, 2) @map("line_total_before_tax")
  taxAmount          Decimal  @db.Decimal(12, 2) @map("tax_amount")
  lineTotal          Decimal  @db.Decimal(12, 2) @map("line_total")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@index([saleId])
  @@index([itemId])
  @@map("sale_items")
}

model Receipt {
  id        String   @id @default(uuid())
  saleId    String   @unique @map("sale_id")
  sale      Sale     @relation(fields: [saleId], references: [id])
  pdfUrl    String?  @map("pdf_url")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("receipts")
}

model Setting {
  id             String   @id @default(uuid())
  ownerUserId    String   @map("owner_user_id")
  owner          User     @relation(fields: [ownerUserId], references: [id])
  businessName   String   @default("My Business") @map("business_name")
  businessAddress String  @default("") @map("business_address")
  phone          String   @default("")
  email          String   @default("")
  currency       String   @default("USD") @db.VarChar(3)
  defaultTaxRate Decimal  @db.Decimal(5, 2) @default(0) @map("default_tax_rate")
  receiptFooter  String   @default("") @map("receipt_footer")
  logoUrl        String?  @map("logo_url")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("settings")
}